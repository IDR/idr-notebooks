"""
Helper functions for accessing the IDR demo from within IPython notebooks.
"""


def annotation_ids_by_field(conn,
                            value="CMPO_0000077",
                            key="Phenotype Term Accession",
                            ns="openmicroscopy.org/omero/bulk_annotations"):
    """
    Return a list of IDs for map annotations with the given namespace
    that have a key=value pair matching the given parameters.
    """
    from omero.rtypes import unwrap
    from omero.sys import ParametersI
    params = ParametersI()
    params.addString("value", value)
    params.addString("key", key)
    params.addString("ns", ns)
    q = (
        "select a.id from MapAnnotation a join a.mapValue as mv "
        "where a.ns = :ns and mv.name = :key and mv.value = :value"
    )
    return unwrap(conn.getQueryService().projection(q, params))[0]


def images_by_phenotype(conn,
                        phenotype="CMPO_0000077"):
    """
    Passes phenotype as the value argument to annotation_ids_by_field
    and loads Image objects which can be used for loading thumbnails, etc.
    """
    ann_ids = annotation_ids_by_field(conn, phenotype)
    return list(conn.getObjectsByAnnotations("Image", ann_ids))


def show_thumbnail(image, *args, **kwargs):
    """
    Given a loaded Image object, retrieve the thumbnail and display it
    inline in the notebook. Arguments are passed directly to the
    getThumbnail method.
    """
    return IPython.display.display(IPython.display.Image(
        data=image.getThumbnail(*args, **kwargs)))


def show_image(image, *args, **kwargs):
    """
    Like show_thumbnail, but display a full-size image.
    """
    return IPython.display.display(IPython.display.Image(
        data=image.renderJpeg(*args, **kwargs)))


def connection():
    """
    Connect to the IDR demo analysis OMERO server
    :return: A BlitzGateway object
    """

    # WARNING: The following block is automatically updated by the IDR
    # deployment scripts. Do not edit this file without testing.
# BEGIN ANSIBLE MANAGED BLOCK
    HOSTNAME = "localhost"
    USERNAME = "omero"
    PASSWORD = "omero"
# END ANSIBLE MANAGED BLOCK

    import omero
    from omero.gateway import BlitzGateway
    c = omero.client(HOSTNAME)
    c.enableKeepAlive(300)
    c.createSession(USERNAME, PASSWORD)
    conn = BlitzGateway(client_obj=c)
    return conn
